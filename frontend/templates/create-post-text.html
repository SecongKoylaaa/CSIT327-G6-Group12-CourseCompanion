{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Post · Text</title>
  <link rel="stylesheet" href="{% static 'css/layout.css' %}?v=20251211">
  <link rel="stylesheet" href="{% static 'css/navbar.css' %}?v=20251211">
  <link rel="stylesheet" href="{% static 'css/post-create.css' %}?v=20251211">
</head>
<body>

  {% include "navbar.html" %}

  <!-- Success message at top -->
  {% if success %}
  <div class="profile-success" id="successMessage" style="margin: 20px auto; max-width: 800px;">
    <span>{{ success }}</span>
    <button type="button" class="success-close" aria-label="Close" onclick="document.getElementById('successMessage').style.display='none'">✖</button>
  </div>
  {% endif %}

  <div class="create-container">
    <div class="create-wrapper">
      
      <div class="create-header">
        <h1>Create a post</h1>
        <p class="subtitle">Share your thoughts with the community</p>
      </div>

      <div class="create-card">

        <!-- Post Type Tabs -->
        <div class="tabs">
          <a href="{% url 'create-post-text' %}" class="tab-item active">
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
            <span>Text</span>
          </a>
          <a href="{% url 'create-post-image-video' %}" class="tab-item">
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
            <span>Media</span>
          </a>
          <a href="{% url 'create-post-link' %}" class="tab-item">
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
              <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
            </svg>
            <span>Link</span>
          </a>
        </div>

        <form method="POST" id="post-form">
          {% csrf_token %}

          <!-- SUBJECT SELECTOR (Replaces Course) -->
          <div class="form-group">
            <label for="subject">
              <!-- Course icon reused -->
              <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
              </svg>
              Subject
            </label>
            <select id="subject" name="subject" required>
              <option value="" disabled {% if not subject %}selected{% endif %}>Choose a subject</option>
              <option value="Filipino" {% if subject == "Filipino" %}selected{% endif %}>Filipino</option>
              <option value="Math" {% if subject == "Math" %}selected{% endif %}>Math</option>
              <option value="Araling Panlipunan" {% if subject == "Araling Panlipunan" %}selected{% endif %}>Araling Panlipunan</option>
              <option value="English" {% if subject == "English" %}selected{% endif %}>English</option>
              <option value="Science" {% if subject == "Science" %}selected{% endif %}>Science</option>
              <option value="Physics" {% if subject == "Physics" %}selected{% endif %}>Physics</option>
              <option value="Chemistry" {% if subject == "Chemistry" %}selected{% endif %}>Chemistry</option>
              <option value="Biology" {% if subject == "Biology" %}selected{% endif %}>Biology</option>
              <option value="History" {% if subject == "History" %}selected{% endif %}>History</option>
              <option value="Geography" {% if subject == "Geography" %}selected{% endif %}>Geography</option>
              <option value="Edukasyon sa Pagpapakatao" {% if subject == "Edukasyon sa Pagpapakatao" %}selected{% endif %}>Edukasyon sa Pagpapakatao</option>
              <option value="Economics" {% if subject == "Economics" %}selected{% endif %}>Economics</option>
              <option value="Technology and Home Economics" {% if subject == "Technology and Home Economics" %}selected{% endif %}>Technology and Home Economics</option>
              <option value="Integrated Science" {% if subject == "Integrated Science" %}selected{% endif %}>Integrated Science</option>
              <option value="Health" {% if subject == "Health" %}selected{% endif %}>Health</option>
              <option value="Music" {% if subject == "Music" %}selected{% endif %}>Music</option>
              <option value="Art" {% if subject == "Art" %}selected{% endif %}>Art</option>
              <option value="Physical Education" {% if subject == "Physical Education" %}selected{% endif %}>Physical Education</option>
            </select>
          </div>

          <!-- Forum Question Toggle -->
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" name="is_forum" id="is_forum" value="true">
              <span class="checkbox-text">
                <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                  <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                Post as a Forum Question (Q&A format)
              </span>
            </label>
            <p class="help-text">Forum questions allow others to provide answers and you can mark the best answer.</p>
          </div>

          <!-- Title -->
          <div class="form-group">
            <label for="title">
              <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="17" y1="10" x2="3" y2="10"/>
                <line x1="21" y1="6" x2="3" y2="6"/>
                <line x1="21" y1="14" x2="3" y2="14"/>
                <line x1="17" y1="18" x2="3" y2="18"/>
              </svg>
              Title
            </label>
            <input type="text" name="title" id="title" maxlength="300"
                   value="{{ title|default:'' }}"
                   placeholder="What's on your mind?" required>
            <div class="char-count" id="title-count">{{ title|length|default:0 }}/300</div>
          </div>

          <!-- Description -->
          <div class="form-group">
            <label for="description">
              <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <polyline points="10 9 9 9 8 9"/>
              </svg>
              Description <span style="color: #999; font-size: 0.9em;">(Optional)</span>
            </label>
            <div class="rte-toolbar">
              <button type="button" class="rte-btn" data-cmd="bold"><b>B</b></button>
              <button type="button" class="rte-btn" data-cmd="italic"><i>I</i></button>
              <button type="button" class="rte-btn" data-cmd="underline"><u>U</u></button>
              <span class="rte-sep"></span>
              <button type="button" class="rte-btn" data-cmd="justifyLeft">Left</button>
              <button type="button" class="rte-btn" data-cmd="justifyCenter">Center</button>
              <button type="button" class="rte-btn" data-cmd="justifyRight">Right</button>
              <span class="rte-sep"></span>
              <button type="button" class="rte-btn" data-cmd="insertUnorderedList"> List</button>
              <button type="button" class="rte-btn" data-cmd="insertOrderedList">1. List</button>
            </div>
            <div id="descEditor" class="rte-editor" contenteditable="true">{{ description|default:''|safe }}</div>
            <textarea name="description" id="description" style="display:none;" maxlength="1000" placeholder="Share more details...">{{ description|default:'' }}</textarea>
            <div class="char-count" id="desc-count">{{ description|length|default:0 }}/1000</div>
          </div>

          <!-- Tag Selector -->
          <div class="form-group">
            <label>
              <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
                <line x1="7" y1="7" x2="7.01" y2="7"/>
              </svg>
              Tag
            </label>

            <div class="tag-selector">
              <button type="button" id="tag-btn" class="tag-dropdown-btn">
                {% if post_type %}
                  <span class="tag-badge tag-{{ post_type }}">{{ post_type|title }}</span>
                {% else %}
                  <span class="tag-placeholder">Select a tag</span>
                {% endif %}
                <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 12 15 18 9"/>
                </svg>
              </button>

              <div id="tag-choices" class="tag-dropdown">
                <button type="button" class="tag-option" data-value="question">
                  <span class="tag-badge tag-question">Question</span>
                </button>
                <button type="button" class="tag-option" data-value="announcement">
                  <span class="tag-badge tag-announcement">Announcement</span>
                </button>
                <button type="button" class="tag-option" data-value="discussion">
                  <span class="tag-badge tag-discussion">Discussion</span>
                </button>
              </div>

              <input type="hidden" name="post_type" id="post_type" value="{{ post_type|default:'' }}">
            </div>
          </div>

          <!-- Messages -->
          {% if error %}
            <div class="alert alert-error">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
              </svg>
              <span>{{ error }}</span>
            </div>
          {% endif %}

          <!-- Action Buttons -->
          <div class="form-actions">
            <a href="/" class="btn-cancel">Cancel</a>
            <button type="submit" class="btn-submit">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="22" y1="2" x2="11" y2="13"/>
                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
              </svg>
              Post
            </button>
          </div>

        </form>
      </div>
    </div>
  </div>

<script>
// Character Counters
const titleInput = document.getElementById('title');
const descInput = document.getElementById('description');
const titleCount = document.getElementById('title-count');
const descCount = document.getElementById('desc-count');

const MAX_TITLE = 300;
const MAX_DESC = 1000;

const updateTitleCount = () => {
  if (!titleInput) return;
  let val = titleInput.value || '';
  if (val.length > MAX_TITLE) {
    val = val.slice(0, MAX_TITLE);
    titleInput.value = val;
  }
  titleCount.textContent = `${val.length}/${MAX_TITLE}`;
  titleCount.classList.toggle('char-limit-reached', val.length >= MAX_TITLE);
};

updateTitleCount();

titleInput.addEventListener('input', updateTitleCount);

// Tag dropdown
const tagBtn = document.getElementById("tag-btn");
const tagChoices = document.getElementById("tag-choices");
const postTypeInput = document.getElementById("post_type");
const forumCheckbox = document.getElementById("is_forum");

// Auto-lock tag to Question when forum is checked
if (forumCheckbox) {
  forumCheckbox.addEventListener("change", () => {
    if (forumCheckbox.checked) {
      // Set to Question
      postTypeInput.value = "question";
      tagBtn.innerHTML = '<span class="tag-badge tag-question">Question</span>';
      const arrow = document.createElement('svg');
      arrow.className = 'dropdown-arrow';
      arrow.setAttribute('viewBox', '0 0 24 24');
      arrow.setAttribute('fill', 'none');
      arrow.setAttribute('stroke', 'currentColor');
      arrow.setAttribute('stroke-width', '2');
      arrow.innerHTML = '<polyline points="6 9 12 15 18 9"/>';
      tagBtn.appendChild(arrow);
      // Disable tag selector
      tagBtn.disabled = true;
      tagBtn.style.opacity = "0.6";
      tagBtn.style.cursor = "not-allowed";
    } else {
      // Enable tag selector
      tagBtn.disabled = false;
      tagBtn.style.opacity = "1";
      tagBtn.style.cursor = "pointer";
    }
  });
}

tagBtn.addEventListener("click", e => {
  e.stopPropagation();
  if (!tagBtn.disabled) {
    tagChoices.classList.toggle("show");
    tagBtn.classList.toggle("active");
  }
});

document.querySelectorAll(".tag-option").forEach(btn => {
  btn.addEventListener("click", () => {
    const value = btn.getAttribute("data-value");
    const badge = btn.querySelector(".tag-badge").cloneNode(true);

    tagBtn.innerHTML = '';
    tagBtn.appendChild(badge);

    const arrow = document.createElement('svg');
    arrow.className = 'dropdown-arrow';
    arrow.setAttribute('viewBox', '0 0 24 24');
    arrow.setAttribute('fill', 'none');
    arrow.setAttribute('stroke', 'currentColor');
    arrow.setAttribute('stroke-width', '2');
    arrow.innerHTML = '<polyline points="6 9 12 15 18 9"/>';
    tagBtn.appendChild(arrow);

    postTypeInput.value = value;
    tagChoices.classList.remove("show");
    tagBtn.classList.remove("active");
  });
});

document.addEventListener("click", e => {
  if (!tagBtn.contains(e.target) && !tagChoices.contains(e.target)) {
    tagChoices.classList.remove("show");
    tagBtn.classList.remove("active");
  }
});

// Form validation
const form = document.getElementById("post-form");
const subjectSelect = document.getElementById("subject");

form.addEventListener("submit", e => {
  if (!postTypeInput.value || !subjectSelect.value) {
    e.preventDefault();
    alert("Please select a subject and a tag before posting!");
    if (!subjectSelect.value) subjectSelect.focus();
    else tagBtn.focus();
  }
});
</script>

<script>
(function(){
  const editor = document.getElementById('descEditor');
  const hidden = document.getElementById('description');
  const counter = document.getElementById('desc-count');
  const MAX = 1000;
  function updateCount(){ if(!editor||!counter) return; const t=(editor.innerText||''); counter.textContent = `${t.length}/${MAX}`; counter.classList.toggle('char-limit-reached', t.length>=MAX); }
  document.querySelectorAll('.rte-btn').forEach(b=>b.addEventListener('click',()=>{ document.execCommand(b.dataset.cmd,false,null); editor&&editor.focus(); updateCount(); }));
  const form = document.getElementById('post-form');
  if(form && editor && hidden){ form.addEventListener('submit',()=>{ hidden.value = (editor.innerHTML||'').trim(); }); }
  editor && editor.addEventListener('input', updateCount);
  updateCount();
})();
</script>

</body>
</html>
