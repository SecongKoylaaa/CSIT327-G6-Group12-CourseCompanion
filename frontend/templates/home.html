{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Course Companion</title>

  <!-- Stylesheets -->
  <link rel="stylesheet" href="{% static 'css/layout.css' %}">
  <link rel="stylesheet" href="{% static 'css/navbar.css' %}">
  <link rel="stylesheet" href="{% static 'css/post.css' %}">
  <link rel="stylesheet" href="{% static 'css/comments.css' %}">
  <link rel="stylesheet" href="{% static 'css/edit_modal.css' %}">
</head>
<body>

  <!-- NAVBAR -->
  {% include "navbar.html" %}

  <!-- MAIN LAYOUT -->
  <div class="main-layout">
    <div class="container">

      {% for post in posts %}
      <div class="post">
        <div class="post-content">

          <!-- POST HEADER -->
          <div class="post-header" style="display:flex; justify-content: space-between; align-items: center;">
            <div>
              <p>
                <span class="subject-tag subject-{{ post.course|slugify }}">{{ post.course }}</span>
                ‚Ä¢ {{ post.author }} ‚Ä¢ {{ post.created_at }}
              </p>
              <h3>{{ post.title }}</h3>
            </div>

            <!-- POST MENU (visible only to post author) -->
            {% if current_user_id == post.user_id %}
            <div class="post-menu-wrapper">
              <span class="post-menu-btn" onclick="togglePostMenu('{{ post.id }}')">‚ãØ</span>
              <div class="post-menu" id="post-menu-{{ post.id }}">
                <button class="edit-btn" onclick="openEditModal({{ post.id }})">Edit</button>
                <form method="POST" action="{% url 'delete_post' post.id %}">
                  {% csrf_token %}
                  <button type="submit" class="delete-btn" onclick="return confirm('Delete this post?')">Delete</button>
                </form>
              </div>
            </div>
            {% endif %}
          </div>

          <!-- POST CONTENT -->
          {% if post.post_type %}
            <p class="post-type">Type: {{ post.post_type }}</p>
          {% endif %}

          {% if post.description %}
            <p class="post-description">{{ post.description }}</p>
          {% endif %}

          {% if post.is_image %}
            <img src="{{ post.url }}" class="post-thumbnail clickable-media" alt="Post Image">
          {% elif post.is_video %}
            <video src="{{ post.url }}" class="post-thumbnail clickable-media" controls muted></video>
          {% elif post.url %}
            <a href="{{ post.url }}" target="_blank" rel="noopener noreferrer">{{ post.url }}</a>
          {% endif %}

          <!-- POST ACTIONS -->
          <div class="actions" data-post-id="{{ post.id }}" data-user-vote="{{ post.user_vote|default:'' }}">
            <button class="vote-btn upvote {% if post.user_vote == 'upvote' %}active-upvote{% endif %}" 
                    onclick="votePost('{{ post.id }}', 'upvote', this)" 
                    aria-label="Upvote">‚¨ÜÔ∏è</button>
            
            <span class="vote-count" id="vote-count-{{ post.id }}">{{ post.vote_count }}</span>
            
            <button class="vote-btn downvote {% if post.user_vote == 'downvote' %}active-downvote{% endif %}" 
                    onclick="votePost('{{ post.id }}', 'downvote', this)" 
                    aria-label="Downvote">‚¨áÔ∏è</button>
            
            <span class="comment-toggle" onclick="toggleComments(this)">
              üí¨ {{ post.comment_count }}
            </span>
            
            <span class="share-btn" onclick="sharePost('{{ post.id }}')">
              üîó Share
            </span>
          </div>

          <!-- COMMENTS SECTION -->
          <div class="expanded-section">
            {% include "comments.html" with post=post %}
          </div>

        </div>
      </div>
      {% empty %}
        <p style="text-align: center; padding: 40px; color: #7c7c7c;">No posts available.</p>
      {% endfor %}
    </div>

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <h3>Subjects</h3>
      <ul class="community-list">
        <li class="community-item {% if not selected_subject %}active{% endif %}">
          <a href="/home/" class="community-link">All Subjects</a>
        </li>
        {% for subj in subjects %}
        <li class="community-item {% if selected_subject == subj %}active{% endif %}">
          <a href="/home/?subject={{ subj|urlencode }}" class="community-link">{{ subj }}</a>
        </li>
        {% endfor %}
      </ul>
    </aside>
  </div>

  <!-- MEDIA MODAL -->
  <div id="mediaModal" class="media-modal">
    <span class="close-modal" aria-label="Close">&times;</span>
    <img id="modalImage" class="modal-content" style="display:none;" alt="Full size image">
    <video id="modalVideo" class="modal-content" controls style="display:none;"></video>
  </div>

  <!-- EDIT POST MODAL -->
  <div id="editPostModal" class="edit-modal" role="dialog" aria-labelledby="modal-title" aria-modal="true">
    <div class="modal-content-edit">

      <!-- Modal Header -->
      <div class="modal-header">
        <h3 id="modal-title">Edit Post</h3>
        <button class="close-edit-modal" onclick="closeEditModal()" aria-label="Close modal">&times;</button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <form id="editPostForm" method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          <div id="edit-form-fields">
            <!-- Form fields dynamically inserted by JavaScript -->
          </div>
        </form>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
          Cancel
        </button>
        <button type="submit" form="editPostForm" class="btn btn-primary">
          Save Changes
        </button>
      </div>

    </div>
  </div>

  <!-- JavaScript Files -->
  <script src="{% static 'js/comments.js' %}"></script>
  <script src="{% static 'js/media_modal.js' %}"></script>
  <script src="{% static 'js/post_menu.js' %}"></script>
  <script src="{% static 'js/edit_modal.js' %}"></script>

</body>
</html>