{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Course Companion</title>

  <!-- Stylesheets -->
  <link rel="stylesheet" href="{% static 'css/layout.css' %}?v=20251211">
  <link rel="stylesheet" href="{% static 'css/navbar.css' %}?v=20251211">
  <link rel="stylesheet" href="{% static 'css/post.css' %}?v=20251211">
  <link rel="stylesheet" href="{% static 'css/comments.css' %}?v=20251211">
  <link rel="stylesheet" href="{% static 'css/edit_modal.css' %}?v=20251211">
</head>
<body>

  <!-- NAVBAR -->
  {% include "navbar.html" %}

  <!-- MAIN LAYOUT -->
  <div class="main-layout">
    <div class="container">

      {% if selected_subject %}
<div class="subject-sort-controls">
  <span>Sort:</span>
  <a href="/home/?subject={{ selected_subject|urlencode }}&sort=top" class="{% if current_sort == 'top' %}active{% endif %}">Top</a>
  <a href="/home/?subject={{ selected_subject|urlencode }}&sort=new" class="{% if current_sort == 'new' %}active{% endif %}">New</a>
  <a href="/home/?subject={{ selected_subject|urlencode }}&sort=old" class="{% if current_sort == 'old' %}active{% endif %}">Old</a>
</div>
{% endif %}{% for post in posts %}
      <div class="post" id="post-{{ post.id }}">
        <div class="post-content">

          <!-- POST HEADER -->
          <div class="post-header" style="display:flex; justify-content: space-between; align-items: center;">
            <div>
              <p>
                <span class="subject-tag subject-{{ post.course|slugify }}">{{ post.course }}</span>
                {% if post.post_type %}<span class="type-tag type-{{ post.post_type|lower }}">{{ post.post_type|title }}</span>{% endif %}
                ‚Ä¢ {{ post.author_name }} ‚Ä¢ {{ post.created_at }}
              </p>
              <h3>{{ post.title }}</h3>
            </div>

            <!-- POST MENU (visible to all users with different options) -->
            <div class="post-menu-wrapper">
              <span class="post-menu-btn" onclick="togglePostMenu('{{ post.id }}')">‚ãØ</span>
              <div class="post-menu" id="post-menu-{{ post.id }}">
                {% if current_user_id == post.user_id %}
                  <!-- Author options -->
                  <button class="edit-btn" onclick="openEditModal('{{ post.id }}')">Edit</button>
                  <form method="POST" action="{% url 'delete_post' post.id %}">
                    {% csrf_token %}
                    <button type="submit" class="delete-btn" onclick="return confirm('Delete this post?')">Delete</button>
                  </form>
                  <button class="report-btn" onclick="reportPost('{{ post.id }}')">Report</button>
                {% else %}
                  <!-- Non-author options -->
                  <button class="report-btn" onclick="reportPost('{{ post.id }}')">Report</button>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- POST CONTENT -->
          

          {% if post.description %}
            <p class="post-description">{{ post.description|safe }}</p>
          {% endif %}

          {% if post.is_image %}
            <img src="{{ post.url }}" class="post-thumbnail clickable-media" alt="Post Image" loading="lazy">
          {% elif post.is_video %}
            <video src="{{ post.url }}" class="post-thumbnail clickable-media" controls muted></video>
          {% elif post.url %}
            <a href="{{ post.url }}" target="_blank" rel="noopener noreferrer">{{ post.url }}</a>
          {% endif %}

          <!-- POST ACTIONS -->
          <div class="actions" data-post-id="{{ post.id }}" data-user-vote="{{ post.user_vote|default:'' }}">
            <button class="vote-btn upvote {% if post.user_vote == 'upvote' %}active-upvote{% endif %}" 
                    onclick="votePost('{{ post.id }}', 'upvote', this)" 
                    aria-label="Upvote">‚¨ÜÔ∏è</button>
            
            <span class="vote-count" id="vote-count-{{ post.id }}">{{ post.vote_count }}</span>
            
            <button class="vote-btn downvote {% if post.user_vote == 'downvote' %}active-downvote{% endif %}" 
                    onclick="votePost('{{ post.id }}', 'downvote', this)" 
                    aria-label="Downvote">‚¨áÔ∏è</button>
            
            <span class="comment-toggle" onclick="toggleComments(this)">
              üí¨ {{ post.comment_count }}
            </span>
            
            <span class="share-btn" onclick="sharePost('{{ post.id }}')">
              üîó Share
            </span>
          </div>

          <!-- COMMENTS SECTION -->
          <div class="expanded-section">
            <div class="comments-section" id="comments-{{ post.id }}" data-post-id="{{ post.id }}" data-loaded="false">
              <div class="comments-placeholder">Comments will load when opened‚Ä¶</div>
            </div>
          </div>

        </div>
      </div>
      {% empty %}
        <p style="text-align: center; padding: 40px; color: #7c7c7c;">No posts available.</p>
      {% endfor %}
    </div>

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <h3>Subjects</h3>
      <ul class="community-list">
        <li class="community-item {% if not selected_subject %}active{% endif %}">
          <a href="/home/" class="community-link">All Subjects</a>
        </li>
        {% for subj in subjects %}
        <li class="community-item {% if selected_subject == subj %}active{% endif %}">
          <a href="/home/?subject={{ subj|urlencode }}" class="community-link">{{ subj }}</a>
        </li>
        {% endfor %}
      </ul>
    </aside>
  </div>

  <!-- MEDIA MODAL -->
  <div id="mediaModal" class="media-modal">
    <span class="close-modal" aria-label="Close">&times;</span>
    <img id="modalImage" class="modal-content" style="display:none;" alt="Full size image">
    <video id="modalVideo" class="modal-content" controls style="display:none;"></video>
  </div>

  <!-- EDIT POST MODAL -->
  <div id="editPostModal" class="edit-modal" role="dialog" aria-labelledby="modal-title" aria-modal="true">
    <div class="modal-content-edit">

      <!-- Modal Header -->
      <div class="modal-header">
        <h3 id="modal-title">Edit Post</h3>
        <button class="close-edit-modal" onclick="closeEditModal()" aria-label="Close modal">&times;</button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <form id="editPostForm" method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          <div id="edit-form-fields">
            <!-- Form fields dynamically inserted by JavaScript -->
          </div>
        </form>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
          Cancel
        </button>
        <button type="submit" form="editPostForm" class="btn btn-primary">
          Save Changes
        </button>
      </div>

    </div>
  </div>

  <!-- REPORT COMMENT MODAL -->
  <div id="reportCommentModal" class="edit-modal" role="dialog" aria-labelledby="report-comment-modal-title" aria-modal="true">
    <div class="modal-content-edit">
      <div class="modal-header">
        <h3 id="report-comment-modal-title">Report Comment</h3>
        <button class="close-edit-modal" onclick="closeReportCommentModal()" aria-label="Close modal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="reportCommentForm" method="POST">
          {% csrf_token %}
          <input type="hidden" id="report_comment_id" name="comment_id">
          <div class="form-group">
            <label for="comment_violation_type">Reason for reporting:</label>
            <select id="comment_violation_type" name="violation_type" required>
              <option value="">Please select a reason...</option>
              <option value="inappropriate_content">Inappropriate Content</option>
              <option value="harassment">Harassment</option>
              <option value="spam">Spam</option>
              <option value="plagiarism">Plagiarism</option>
              <option value="misinformation">Misinformation</option>
              <option value="hate_speech">Hate Speech</option>
              <option value="violence">Violence or Threats</option>
              <option value="copyright">Copyright Violation</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="report_comment_details">Additional details (optional):</label>
            <textarea id="report_comment_details" name="details" rows="4" placeholder="Please provide any additional context that might help us review this report..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeReportCommentModal()">Cancel</button>
        <button type="submit" form="reportCommentForm" class="btn btn-primary" onclick="submitCommentReport()">Submit Report</button>
      </div>
    </div>
  </div>

  <!-- REPORT POST MODAL -->
  <div id="reportPostModal" class="edit-modal" role="dialog" aria-labelledby="report-modal-title" aria-modal="true">
    <div class="modal-content-edit">

      <!-- Modal Header -->
      <div class="modal-header">
        <h3 id="report-modal-title">Report Post</h3>
        <button class="close-edit-modal" onclick="closeReportModal()" aria-label="Close modal">&times;</button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <form id="reportPostForm" method="POST">
          {% csrf_token %}
          <input type="hidden" id="report_post_id" name="post_id">
          
          <div class="form-group">
            <label for="violation_type">Reason for reporting:</label>
            <select id="violation_type" name="violation_type" required>
              <option value="">Please select a reason...</option>
              <option value="inappropriate_content">Inappropriate Content</option>
              <option value="harassment">Harassment</option>
              <option value="spam">Spam</option>
              <option value="plagiarism">Plagiarism</option>
              <option value="misinformation">Misinformation</option>
              <option value="hate_speech">Hate Speech</option>
              <option value="violence">Violence or Threats</option>
              <option value="copyright">Copyright Violation</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="form-group">
            <label for="report_details">Additional details (optional):</label>
            <textarea id="report_details" name="details" rows="4" placeholder="Please provide any additional context that might help us review this report..."></textarea>
          </div>
        </form>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeReportModal()">
          Cancel
        </button>
        <button type="submit" form="reportPostForm" class="btn btn-primary" onclick="submitReport()">
          Submit Report
        </button>
      </div>

    </div>
  </div>

  <!-- JavaScript Files -->
  <script src="{% static 'js/comments.js' %}?v=20251211"></script>
  <script src="{% static 'js/media_modal.js' %}?v=20251211"></script>
  <script src="{% static 'js/post_menu.js' %}?v=20251211"></script>
  <script src="{% static 'js/edit_modal.js' %}?v=20251211"></script>
  <script src="{% static 'js/report_modal.js' %}?v=20251211"></script>

  <!-- Pagination Controls -->
  <div class="pagination" style="text-align:center; padding:20px;">
    {% if has_prev %}
      <a class="btn" href="/home/?page={{ page|add:-1 }}{% if selected_subject %}&subject={{ selected_subject|urlencode }}{% endif %}">Previous</a>
    {% endif %}
    <span style="margin:0 12px;">Page {{ page }}</span>
    {% if has_next %}
      <a class="btn" href="/home/?page={{ page|add:1 }}{% if selected_subject %}&subject={{ selected_subject|urlencode }}{% endif %}">Next</a>
    {% endif %}
  </div>

</body>
</html>
