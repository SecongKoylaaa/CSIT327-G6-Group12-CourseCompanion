{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Course Companion</title>
  <link rel="stylesheet" href="{% static 'css/home.css' %}">
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar">
  <div class="nav-left">
    <img src="https://img.icons8.com/ios-filled/50/ff4500/handshake.png" alt="logo" class="logo">
    <h1 class="logo-text">Course Companion</h1>
  </div>

  <div class="nav-center">
    <input type="text" class="search-bar" placeholder="Search Course Companion...">
  </div>

  <div class="nav-right">
    <a href="{% url 'create-post-text' %}" class="create-btn">+ Create</a>
    <div class="profile-dropdown">
      <button class="profile-btn">üë§</button>
      <div class="dropdown-content">
        <a href="#">View Profile</a>
        <a href="/logout/">Logout</a>
      </div>
    </div>
  </div>
</nav>

<!-- MAIN LAYOUT -->
<div class="main-layout">
  <div class="container">
    {% for post in posts %}
    <div class="post">
      <div class="post-content">
        <p><b>{{ post.course }}</b> ‚Ä¢ {{ post.created_at }}</p>
        <h3>{{ post.title }}</h3>

        {% if post.description %}
          <p class="post-description">{{ post.description }}</p>
        {% endif %}

        {% if post.is_image %}
          <img src="{{ post.url }}" alt="Post Image" class="post-thumbnail">
        {% elif post.is_video %}
          <video class="post-thumbnail" src="{{ post.url }}" controls></video>
        {% elif post.url %}
          <a href="{{ post.url }}" target="_blank">{{ post.url }}</a>
        {% endif %}

       <!-- ACTIONS -->
        <div class="actions" data-post-id="{{ post.id }}">
          <button class="vote-btn upvote">‚¨ÜÔ∏è</button>
          <span class="vote-count" id="vote-count-{{ post.id }}">{{ post.vote_count }}</span>
          <button class="vote-btn downvote">‚¨áÔ∏è</button>
          <span class="comment-toggle" onclick="toggleComments(this)">üí¨ {{ post.comment_count }}</span>
          <span>üîó Share</span>
        </div>




        <!-- COMMENTS SECTION -->
        <div class="expanded-section">
          <div class="comments-area">
            <h4>Comments</h4>
            {% for comment in post.comments %}
              {% include "comment_thread.html" with comment=comment post_id=post.id %}
            {% empty %}
              <p class="no-comments">No comments yet.</p>
            {% endfor %}

            <form class="comment-form" method="POST" action="{% url 'home' %}">
              {% csrf_token %}
              <input type="hidden" name="post_id" value="{{ post.id }}">
              <input type="text" name="comment" placeholder="Add a comment..." required>
              <button type="submit">Post</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% empty %}
      <p>No posts available.</p>
    {% endfor %}
  </div>

  <aside class="sidebar">
    <h3>Communities</h3>
    <ul>
      <li>r/Psychology</li>
      <li>r/HowToProgramming</li>
      <li>r/ThisIsATest</li>
      <li>r/HelloWorld</li>
      <li>r/Nursing</li>
      <li>r/Engineering</li>
    </ul>
  </aside>
</div>
<!-- ------------------- SCRIPTS ------------------- -->
<script>
  // -------------------- COMMENTS TOGGLE --------------------
  function toggleComments(el) {
    const post = el.closest(".post");
    post.classList.toggle("show-expanded");
  }

  // -------------------- PROFILE DROPDOWN --------------------
  document.addEventListener("click", function(e) {
    const dropdown = document.querySelector(".dropdown-content");
    const button = document.querySelector(".profile-btn");
    if (button && button.contains(e.target)) {
      dropdown.classList.toggle("show");
    } else if (dropdown) {
      dropdown.classList.remove("show");
    }
  });

  // -------------------- POST VOTING SYSTEM --------------------
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".actions").forEach(actionDiv => {
      const postId = actionDiv.dataset.postId;
      const upBtn = actionDiv.querySelector(".upvote");
      const downBtn = actionDiv.querySelector(".downvote");
      const voteCount = actionDiv.querySelector(".vote-count");

      if (!postId || !upBtn || !downBtn) return;

      upBtn.addEventListener("click", () => handleVote(postId, "upvote", voteCount, upBtn, downBtn));
      downBtn.addEventListener("click", () => handleVote(postId, "downvote", voteCount, upBtn, downBtn));
    });
  });

  async function handleVote(postId, voteType, voteCountElem, upBtn, downBtn) {
    try {
      const response = await fetch(`/vote_post/${postId}/${voteType}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
          "Accept": "application/json"
        },
        credentials: "same-origin"
      });

      const data = await response.json();

      if (response.ok) {
        // Update displayed vote count
        voteCountElem.textContent = data.net_votes;

        // Remove previous highlights
        upBtn.classList.remove("active");
        downBtn.classList.remove("active");

        // Highlight according to returned user vote
        if (data.user_vote === "upvote") upBtn.classList.add("active");
        if (data.user_vote === "downvote") downBtn.classList.add("active");
      } else {
        console.error("Vote error:", data);
        alert(data.error || "Something went wrong.");
      }
    } catch (err) {
      console.error("Vote request failed:", err);
    }
  }


  // -------------------- COMMENT VOTING SYSTEM --------------------
  function voteComment(commentId, type, btn) {
    const container = btn.closest(".comment-votes");
    const voteCountElem = container.querySelector(".comment-vote-count");
    const upBtn = container.querySelector(".comment-upvote");
    const downBtn = container.querySelector(".comment-downvote");

    fetch(`/vote_comment/${commentId}/${type}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": getCookie("csrftoken"),
        "Accept": "application/json"
      },
      credentials: "same-origin"
    })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          console.error(data.error);
          return;
        }
        voteCountElem.textContent = data.net_votes;
        upBtn.classList.remove("active");
        downBtn.classList.remove("active");
        if (data.user_vote === "upvote") upBtn.classList.add("active");
        if (data.user_vote === "downvote") downBtn.classList.add("active");
      })
      .catch(err => console.error("Comment vote error:", err));
  }

  // -------------------- REPLY FORM TOGGLE --------------------
  let openReplyForm = null;
  function toggleReplyForm(commentId) {
    const form = document.getElementById(`reply-form-${commentId}`);
    if (!form) return;

    if (openReplyForm && openReplyForm !== form) {
      openReplyForm.style.display = "none";
    }

    if (form.style.display === "none" || form.style.display === "") {
      form.style.display = "flex";
      form.querySelector('input[type="text"]').focus();
      openReplyForm = form;
    } else {
      form.style.display = "none";
      openReplyForm = null;
    }
  }

  // -------------------- COMMENT MENU TOGGLE --------------------
  let openCommentMenu = null;
  function toggleCommentMenu(commentId) {
    const menu = document.getElementById(`comment-menu-${commentId}`);
    if (!menu) return;

    if (openCommentMenu && openCommentMenu !== menu) {
      openCommentMenu.style.display = "none";
    }

    if (menu.style.display === "none" || menu.style.display === "") {
      menu.style.display = "block";
      openCommentMenu = menu;
    } else {
      menu.style.display = "none";
      openCommentMenu = null;
    }
  }

  document.addEventListener("click", function(e) {
    if (!e.target.classList.contains("comment-menu-btn")) {
      const openMenus = document.querySelectorAll(".comment-menu");
      openMenus.forEach(menu => {
        if (menu.style.display === "block") {
          menu.style.display = "none";
          openCommentMenu = null;
        }
      });
    }
  });

  // -------------------- SHOW/HIDE MORE COMMENTS --------------------
  function toggleMoreComments(commentId) {
    const hidden = document.getElementById(`hidden-replies-${commentId}`);
    const button = document.querySelector(`.more-replies[data-comment-id="${commentId}"]`);
    if (!hidden || !button) return;

    if (hidden.style.display === "none" || hidden.style.display === "") {
      hidden.style.display = "block";
      button.textContent = "Hide comments";
    } else {
      hidden.style.display = "none";
      button.textContent = "Show more comments";
    }
  }

  function showAndFocusReplies(commentId) {
    toggleMoreComments(commentId);
    const hidden = document.getElementById(`hidden-replies-${commentId}`);
    if (hidden) {
      const input = hidden.querySelector('input[type="text"]');
      if (input) input.focus();
    }
  }

  // -------------------- EDIT FORM TOGGLE --------------------
  function toggleEditForm(commentId) {
    const form = document.getElementById(`edit-form-${commentId}`);
    const text = document.getElementById(`comment-text-${commentId}`);
    if (!form || !text) return;

    if (form.style.display === "none" || form.style.display === "") {
      form.style.display = "flex";
      text.style.display = "none";
    } else {
      form.style.display = "none";
      text.style.display = "block";
    }
  }

  function cancelEdit(commentId) {
    const form = document.getElementById(`edit-form-${commentId}`);
    const text = document.getElementById(`comment-text-${commentId}`);
    if (!form || !text) return;
    form.style.display = "none";
    text.style.display = "block";
  }

  // -------------------- CSRF HELPER --------------------
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
  }
</script>



</body>
</html>
