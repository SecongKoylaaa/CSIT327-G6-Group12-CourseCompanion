{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="{% static 'css/layout.css' %}">
  <link rel="stylesheet" href="{% static 'css/navbar.css' %}">
  <link rel="stylesheet" href="{% static 'css/admin.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <meta name="csrf-token" content="{{ csrf_token }}">
</head>
<body>
  <nav class="admin-navbar">
    <div class="admin-nav-container">
      <div class="admin-nav-brand">
        <i class="fas fa-shield-alt"></i>
        <span>Course Companion Admin</span>
      </div>
      <div class="admin-nav-menu">
        <a href="#dashboard" class="nav-link active" onclick="showTab('dashboard', event)">
          <i class="fas fa-chart-line"></i>
          <span>Dashboard</span>
        </a>
        <a href="#users" class="nav-link" onclick="showTab('users', event)">
          <i class="fas fa-users"></i>
          <span>Users</span>
        </a>
        <a href="#subjects" class="nav-link" onclick="showTab('subjects', event)">
          <i class="fas fa-book"></i>
          <span>Subjects</span>
        </a>
        <a href="#reports" class="nav-link" onclick="showTab('reports', event)">
          <i class="fas fa-flag"></i>
          <span>Reports & Moderation</span>
        </a>
      </div>
      <div class="admin-nav-actions">
        <a href="{% url 'logout' %}" class="btn btn-secondary btn-sm">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </a>
      </div>
    </div>
  </nav>

  <div class="admin-container">
    <div id="dashboard-tab" class="tab-content active">
      <h1 class="admin-page-title">Dashboard Overview</h1>
      <div class="dashboard-grid">
        <div class="dashboard-box users-box">
          <div class="box-icon"><i class="fas fa-users"></i></div>
          <div class="box-content">
            <h3>{{ total_users }}</h3>
            <p>Total Users</p>
          </div>
        </div>
        <div class="dashboard-box posts-box">
          <div class="box-icon"><i class="fas fa-file-alt"></i></div>
          <div class="box-content">
            <h3>{{ total_posts }}</h3>
            <p>Total Posts</p>
          </div>
        </div>
        <div class="dashboard-box reports-box">
          <div class="box-icon"><i class="fas fa-flag"></i></div>
          <div class="box-content">
            <h3>{{ total_reports }}</h3>
            <p>Post Reports</p>
          </div>
        </div>
        <div class="dashboard-box subjects-box">
          <div class="box-icon"><i class="fas fa-book-open"></i></div>
          <div class="box-content">
            <h3>{{ active_subjects }}</h3>
            <p>Active Subjects</p>
          </div>
        </div>
      </div>
    </div>

    <div id="users-tab" class="tab-content">
      <h1 class="admin-page-title">Users</h1>
      <div class="users-container">
        <div class="users-header">
          <h2>All Users ({{ total_users }})</h2>
          <div class="search-box">
            <input type="text" id="user-search" placeholder="Search by username or email" onkeyup="searchUsers()">
          </div>
        </div>
        <div class="users-list">
          {% for user in users %}
          <div class="user-card" data-username="{{ user.username|default:user.email }}" data-email="{{ user.email }}">
            <div class="user-avatar">
              <i class="fas fa-user-circle"></i>
            </div>
            <div class="user-info">
              <h4>{{ user.username|default:"No username" }}</h4>
              <p>{{ user.email }}</p>
              <small>Joined: {{ user.date_joined|default:user.created_at|date:"M d, Y" }}</small>
            </div>
            <div class="user-actions">
              <button class="btn btn-sm btn-secondary" onclick="viewUserDetails('{{ user.id }}')">
                <i class="fas fa-eye"></i> View
              </button>
            </div>
          </div>
          {% empty %}
          <div class="no-data">
            <i class="fas fa-users"></i>
            <p>No users found.</p>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div id="subjects-tab" class="tab-content">
      <h1 class="admin-page-title">Posts by Subject</h1>
      <div class="subjects-grid">
        {% for subject, posts in posts_by_subject.items %}
        <div class="subject-box" onclick="showSubjectDetails('{{ subject }}')">
          <div class="subject-icon">
            <i class="fas fa-book"></i>
          </div>
          <div class="subject-content">
            <h3>{{ subject }}</h3>
            <p>{{ posts|length }} posts</p>
          </div>
          <div class="subject-arrow">
            <i class="fas fa-arrow-right"></i>
          </div>
        </div>
        {% empty %}
        <div class="no-data">
          <i class="fas fa-book"></i>
          <p>No posts found.</p>
        </div>
        {% endfor %}
      </div>
      <div id="subjectModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="subjectModalTitle">Subject Posts</h3>
            <button class="close-modal" onclick="closeSubjectModal()">&times;</button>
          </div>
          <div class="modal-body" id="subjectModalBody"></div>
        </div>
      </div>
    </div>

    <div id="reports-tab" class="tab-content">
      <h1 class="admin-page-title">Reports & Moderation</h1>
      <div class="reports-container">
        <div class="reports-header">
          <h2>Post Reports ({{ total_reports }})</h2>
          <div class="filter-box">
            <select id="report-filter" onchange="filterReports()">
              <option value="all">All Reports</option>
              <option value="pending">Pending</option>
              <option value="under_review">Under Review</option>
              <option value="resolved">Resolved</option>
              <option value="dismissed">Dismissed</option>
            </select>
          </div>
        </div>
        <div class="reports-list">
          {% for report in reports %}
          <div class="report-card" data-status="{{ report.status }}" data-report-id="{{ report.report_id }}">
            <div class="report-header">
              <div class="report-info">
                <h4>{{ report.post_title }}</h4>
                <span class="report-status status-{{ report.status }}">{{ report.status|title }}</span>
              </div>
              <div class="report-date">
                {{ report.created_at|date:"M d, Y H:i" }}
              </div>
            </div>
            <div class="report-body">
              <div class="report-col report-post">
                <div class="detail-row">
                  <strong>Subject:</strong> {{ report.post_subject }}
                </div>
                <div class="detail-row">
                  <strong>Post Author:</strong> {{ report.post_author }}
                </div>
                {% if report.post_description %}
                <div class="detail-row">
                  <strong>Description:</strong> {{ report.post_description }}
                </div>
                {% endif %}
                {% if report.post_is_image %}
                <div class="report-media">
                  <img src="{{ report.post_url }}" alt="Reported post image">
                </div>
                {% elif report.post_is_video %}
                <div class="report-media">
                  <video src="{{ report.post_url }}" controls muted></video>
                </div>
                {% elif report.post_url %}
                <div class="detail-row">
                  <strong>Link:</strong> <a href="{{ report.post_url }}" target="_blank" rel="noopener noreferrer">{{ report.post_url }}</a>
                </div>
                {% endif %}
              </div>
              <div class="report-col report-meta">
                <div class="detail-row">
                  <strong>Reported by:</strong> {{ report.reporter_email }}
                </div>
                <div class="detail-row">
                  <strong>Violation Type:</strong> {{ report.violation_label|default:"Unknown" }}
                </div>
                {% if report.user_description %}
                <div class="detail-row">
                  <strong>User Description:</strong> {{ report.user_description }}
                </div>
                {% endif %}
                <div class="report-actions">
                  <div class="detail-row">
                    <strong>Status:</strong>
                    <select onchange="updateReportStatus('{{ report.report_id }}', this.value)">
                      <option value="pending" {% if report.status == 'pending' %}selected{% endif %}>Pending</option>
                      <option value="under_review" {% if report.status == 'under_review' %}selected{% endif %}>Under Review</option>
                      <option value="resolved" {% if report.status == 'resolved' %}selected{% endif %}>Resolved</option>
                      <option value="dismissed" {% if report.status == 'dismissed' %}selected{% endif %}>Dismissed</option>
                    </select>
                  </div>
                  <button class="btn btn-sm btn-danger" onclick="adminDeletePost('{{ report.post_id }}')">
                    <i class="fas fa-trash"></i> Delete Post
                  </button>
                </div>
              </div>
            </div>
          </div>
          {% empty %}
          <div class="no-data">
            <i class="fas fa-flag"></i>
            <p>No post reports found.</p>
          </div>
          {% endfor %}
        </div>

        <div class="reports-header" style="margin-top: 2rem;">
          <h2>Comment Reports ({{ total_comment_reports }})</h2>
        </div>
        <div class="reports-list">
          {% for c_report in comment_reports %}
          <div class="report-card" data-status="{{ c_report.status }}" data-comment-report-id="{{ c_report.report_id }}">
            <div class="report-header">
              <div class="report-info">
                <h4>Comment on: {{ c_report.post_title }}</h4>
                <span class="report-status status-{{ c_report.status }}">{{ c_report.status|title }}</span>
              </div>
              <div class="report-date">
                {{ c_report.created_at|date:"M d, Y H:i" }}
              </div>
            </div>
            <div class="report-body">
              <div class="report-col report-post">
                <div class="detail-row">
                  <strong>Subject:</strong> {{ c_report.post_subject }}
                </div>
                <div class="detail-row">
                  <strong>Post Title:</strong> {{ c_report.post_title }}
                </div>
                {% if c_report.post_description %}
                <div class="detail-row">
                  <strong>Post Description:</strong> {{ c_report.post_description }}
                </div>
                {% endif %}
                <div class="detail-row">
                  <strong>Comment Author:</strong> {{ c_report.comment_author }}
                </div>
                <div class="detail-row">
                  <strong>Comment Text:</strong> {{ c_report.comment_text }}
                </div>
              </div>
              <div class="report-col report-meta">
                <div class="detail-row">
                  <strong>Reported by:</strong> {{ c_report.reporter_email }}
                </div>
                <div class="detail-row">
                  <strong>Violation Type:</strong> {{ c_report.violation_label|default:"Unknown" }}
                </div>
                {% if c_report.user_description %}
                <div class="detail-row">
                  <strong>User Description:</strong> {{ c_report.user_description }}
                </div>
                {% endif %}
                <div class="report-actions">
                  <div class="detail-row">
                    <strong>Status:</strong>
                    <select onchange="updateCommentReportStatus('{{ c_report.report_id }}', this.value)">
                      <option value="pending" {% if c_report.status == 'pending' %}selected{% endif %}>Pending</option>
                      <option value="under_review" {% if c_report.status == 'under_review' %}selected{% endif %}>Under Review</option>
                      <option value="resolved" {% if c_report.status == 'resolved' %}selected{% endif %}>Resolved</option>
                      <option value="dismissed" {% if c_report.status == 'dismissed' %}selected{% endif %}>Dismissed</option>
                    </select>
                  </div>
                  <button class="btn btn-sm btn-danger" onclick="adminDeleteComment('{{ c_report.comment_id }}')">
                    <i class="fas fa-trash"></i> Delete Comment
                  </button>
                </div>
              </div>
            </div>
          </div>
          {% empty %}
          <div class="no-data">
            <i class="fas fa-comment-slash"></i>
            <p>No comment reports found.</p>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="{% static 'js/admin.js' %}"></script>
</body>
</html>
